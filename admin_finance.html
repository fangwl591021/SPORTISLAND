<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>金流管理後台</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-[#F4F5F7] font-sans">

<div class="max-w-6xl mx-auto p-8">
  <h1 class="text-2xl font-bold text-[#06C755] mb-6">金流狀態管理</h1>

  <table class="w-full bg-white rounded-xl overflow-hidden shadow">
    <thead class="bg-[#F0FBF5] text-[#06C755]">
      <tr>
        <th class="p-3 text-left">學員</th>
        <th class="p-3">課程</th>
        <th class="p-3">應付</th>
        <th class="p-3">實付</th>
        <th class="p-3">狀態</th>
        <th class="p-3">操作</th>
      </tr>
    </thead>
    <tbody id="financeBody"></tbody>
  </table>
</div>

<script>
const API_URL = 'https://sport.wetw-net3.workers.dev/';

async function loadFinance(){
  const res = await fetch(API_URL,{
    method:'POST',
    body:JSON.stringify({action:'adminGetRegistrations'})
  });
  const data = await res.json();

  document.getElementById('financeBody').innerHTML = data.data.map(r=>`
    <tr class="border-t">
      <td class="p-3">${r.name}</td>
      <td class="p-3">${r.course}</td>
      <td class="p-3">$${r.payable}</td>
      <td class="p-3">
        <input type="number" id="paid-${r.row}" value="${r.paid}"
          class="border rounded px-2 py-1 w-24">
      </td>
      <td class="p-3">
        <select id="status-${r.row}" class="border rounded px-2 py-1">
          <option ${r.status==='PENDING'?'selected':''}>PENDING</option>
          <option ${r.status==='PAID'?'selected':''}>PAID</option>
          <option ${r.status==='WAITLIST'?'selected':''}>WAITLIST</option>
          <option ${r.status==='REFUNDED'?'selected':''}>REFUNDED</option>
        </select>
      </td>
      <td class="p-3">
        <button onclick="save(${r.row})"
          class="bg-[#06C755] text-white px-4 py-1 rounded">
          儲存
        </button>
      </td>
    </tr>
  `).join('');
}

async function save(row){
  await fetch(API_URL,{
    method:'POST',
    body:JSON.stringify({
      action:'adminUpdatePayment',
      row,
      paid:document.getElementById('paid-'+row).value,
      status:document.getElementById('status-'+row).value
    })
  });
  alert('已更新');
}

loadFinance();
</script>
</body>
</html>
