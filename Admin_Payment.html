<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>金流對帳｜運動島</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
:root{--line:#06C755}
.btn{background:var(--line);color:#fff;font-weight:700}
</style>
</head>

<body class="bg-[#F4F5F7] p-6">
<h1 class="text-2xl font-black mb-6">金流對帳管理</h1>

<table class="w-full bg-white rounded-xl overflow-hidden text-sm">
<thead class="bg-[#F0FBF5] text-[#06C755] font-bold">
<tr>
<th class="p-3">學員</th>
<th>課程</th>
<th>應付</th>
<th>實付</th>
<th>狀態</th>
<th>方式</th>
<th>操作</th>
</tr>
</thead>
<tbody id="payTable"></tbody>
</table>

<script>
const API = "https://sport.wetw-net3.workers.dev/";

async function loadPayments(){
  const res = await fetch(API,{
    method:'POST',
    body:JSON.stringify({action:'getUserRegistrations', admin:true})
  }).then(r=>r.json());

  payTable.innerHTML = (res.data||[]).map(r=>`
    <tr class="border-b">
      <td class="p-2">${r.姓名}</td>
      <td>${r.課程}</td>
      <td>$${r.應付金額 || 0}</td>
      <td>
        <input class="border p-1 w-24" value="${r.實付金額 || ''}" id="paid-${r.id}">
      </td>
      <td>${r.金流狀態 || '待付款'}</td>
      <td>
        <select id="method-${r.id}" class="border p-1">
          <option>轉帳</option>
          <option>LINE Pay</option>
          <option>現金</option>
        </select>
      </td>
      <td>
        <button class="btn px-3 py-1 rounded"
          onclick="confirmPay('${r.id}')">確認付款</button>
      </td>
    </tr>
  `).join('');
}

function confirmPay(id){
  const paid = document.getElementById(`paid-${id}`).value;
  const method = document.getElementById(`method-${id}`).value;

  fetch(API,{
    method:'POST',
    body:JSON.stringify({
      action:'updatePaymentFlow',
      registerId:id,
      paidAmount:paid,
      method,
      status:'已付款',
      admin:'admin'
    })
  }).then(()=>loadPayments());
}

loadPayments();
</script>
</body>
</html>
