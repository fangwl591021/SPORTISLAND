<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>運動島會員</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>

<body class="bg-slate-100">

<!-- BANNER -->
<div class="bg-[#06C755] text-white text-center py-4 font-black text-xl">
  運動島 Sports Island
</div>

<!-- 會員列表 -->
<div id="view-member" class="p-4">
  <div class="flex justify-between items-center mb-3">
    <h2 class="font-black text-lg">會員名冊</h2>
    <button onclick="openAdd()" class="text-[#06C755] font-bold">＋ 新增家人</button>
  </div>
  <div id="familyList" class="space-y-3"></div>
</div>

<!-- 新增 / 編輯 -->
<div id="view-form" class="hidden p-4">
  <h2 id="formTitle" class="font-black text-lg mb-3">新增家人</h2>

  <input type="hidden" id="rowIndex">

  <input id="name" class="w-full p-3 border rounded mb-2" placeholder="姓名">
  <input id="phone" class="w-full p-3 border rounded mb-2" placeholder="電話">

  <select id="gender" class="w-full p-3 border rounded mb-2">
    <option value="">性別</option>
    <option>男</option>
    <option>女</option>
  </select>

  <input id="birthday" type="date" class="w-full p-3 border rounded mb-2">

  <select id="address" class="w-full p-3 border rounded mb-2">
    <option>台北市</option><option>新北市</option><option>桃園市</option>
    <option>台中市</option><option>台南市</option><option>高雄市</option>
  </select>

  <select id="relation" class="w-full p-3 border rounded mb-2">
    <option>本人</option>
    <option>子女</option>
    <option>家人</option>
  </select>

  <!-- ⭐ 身分別 -->
  <select id="identity" class="w-full p-3 border rounded mb-4">
    <option value="一般">一般身分</option>
    <option value="學生">學生</option>
  </select>

  <div class="flex gap-3">
    <button onclick="save()" class="flex-1 bg-[#06C755] text-white py-3 rounded font-bold">
      儲存
    </button>
    <button onclick="cancel()" class="flex-1 border border-[#06C755] text-[#06C755] py-3 rounded font-bold">
      取消
    </button>
  </div>
</div>

<script>
const API = "https://sport.wetw-net3.workers.dev/";
let uid = "";

async function init(){
  await liff.init({ liffId:"2008792551-CzPJtVB1" });
  if(!liff.isLoggedIn()) return liff.login();
  uid = (await liff.getProfile()).userId;
  loadFamily();
}

async function loadFamily(){
  const res = await fetch(API,{
    method:'POST',
    body:JSON.stringify({action:'getFamily', userId:uid})
  }).then(r=>r.json());

  familyList.innerHTML = res.data.map(m=>`
    <div class="bg-white p-3 rounded flex justify-between">
      <div>
        <div class="font-bold">${m.name}</div>
        <div class="text-xs text-slate-500">${m.relation}｜${m.identity}</div>
      </div>
      <button class="text-[#06C755]" onclick='edit(${JSON.stringify(m)})'>編輯</button>
    </div>
  `).join('');
}

function openAdd(){
  viewForm();
}

function edit(m){
  viewForm("編輯會員");
  rowIndex.value = m.rowIndex;
  name.value = m.name;
  phone.value = m.phone;
  gender.value = m.gender;
  birthday.value = m.birthday;
  address.value = m.address;
  relation.value = m.relation;
  identity.value = m.identity;
}

async function save(){
  const action = rowIndex.value ? 'updateFamily' : 'addFamily';
  await fetch(API,{
    method:'POST',
    body:JSON.stringify({
      action,
      rowIndex: rowIndex.value,
      userId: uid,
      name: name.value,
      phone: phone.value,
      gender: gender.value,
      birthday: birthday.value,
      address: address.value,
      relation: relation.value,
      identity: identity.value
    })
  });
  cancel();
  loadFamily();
}

function cancel(){
  viewMember();
}

function viewForm(title="新增家人"){
  view-member.classList.add('hidden');
  view-form.classList.remove('hidden');
  formTitle.innerText = title;
}

function viewMember(){
  view-form.classList.add('hidden');
  view-member.classList.remove('hidden');
  rowIndex.value="";
}

window.onload = init;
</script>
</body>
</html>
