<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>é‹å‹•å³¶ï½œèª²ç¨‹å ±å</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwindï¼ˆé–‹ç™¼ç‰ˆï¼‰ -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- LIFF -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
    body { font-family: 'Noto Sans TC', sans-serif; background:#F4F5F7; }
    .card { background:#fff; border-radius:16px; border:1px solid #E5E7EB; }
    .btn-line { background:#06C755; color:#fff; font-weight:700; }
    .btn-line:hover { background:#05b94d; }
    .slot-btn { border:1px solid #E5E7EB; border-radius:12px; padding:12px; font-weight:700; }
    .slot-btn.active { background:#06C755; color:#fff; border-color:#06C755; }
  </style>
</head>

<body class="pb-24">

<!-- Header -->
<div class="bg-white shadow sticky top-0 z-10">
  <div class="max-w-md mx-auto p-4 flex justify-between items-center">
    <h1 class="font-black text-lg">é‹å‹•å³¶ èª²ç¨‹å ±å</h1>
    <div id="userName" class="text-sm text-slate-500">è¼‰å…¥ä¸­...</div>
  </div>
</div>

<!-- Main -->
<div class="max-w-md mx-auto p-4 space-y-6">

  <!-- èª²ç¨‹ -->
  <div class="card p-5">
    <h2 class="font-black text-lg mb-3">â‘  é¸æ“‡èª²ç¨‹</h2>
    <select id="courseSelect" class="w-full p-3 border rounded-xl font-bold">
      <option value="">è«‹é¸æ“‡èª²ç¨‹</option>
    </select>
  </div>

  <!-- æ—¥æœŸ -->
  <div class="card p-5 hidden" id="dateCard">
    <h2 class="font-black text-lg mb-3">â‘¡ é¸æ“‡æ—¥æœŸ</h2>
    <div id="dateList" class="grid grid-cols-3 gap-3"></div>
  </div>

  <!-- Slot -->
  <div class="card p-5 hidden" id="slotCard">
    <h2 class="font-black text-lg mb-3">â‘¢ é¸æ“‡æ™‚æ®µ</h2>
    <div id="slotList" class="space-y-3"></div>
  </div>

  <!-- é‡‘é¡ -->
  <div class="card p-5 hidden" id="priceCard">
    <h2 class="font-black text-lg mb-2">â‘£ æ‡‰ä»˜é‡‘é¡</h2>
    <div class="flex justify-between items-center">
      <span class="text-slate-500 font-bold">æœ¬æ¬¡å ±å</span>
      <span id="priceText" class="text-2xl font-black text-green-600">$0</span>
    </div>
  </div>

  <!-- é€å‡º -->
  <div class="hidden" id="submitCard">
    <button onclick="submitRegistration()" class="w-full py-4 btn-line rounded-2xl text-lg">
      ç¢ºèªå ±åï¼ˆå°šæœªä»˜æ¬¾ï¼‰
    </button>
  </div>

</div>

<script>
/* ===============================
 * ğŸ”’ API é–å®šï¼ˆæœ€é‡è¦ï¼‰
 * =============================== */
const API_URL = "https://sport-island.fangwl591021.workers.dev";

/* ===============================
 * ç‹€æ…‹
 * =============================== */
let currentUserId = '';
let slotData = [];
let selectedSlot = null;

/* ===============================
 * LIFF
 * =============================== */
async function initLiff(){
  await liff.init({ liffId:'2008792551-CzPJtVB1' });
  if(!liff.isLoggedIn()){ liff.login(); return; }
  const profile = await liff.getProfile();
  currentUserId = profile.userId;
  document.getElementById('userName').innerText = profile.displayName;
}

/* ===============================
 * èª²ç¨‹
 * =============================== */
async function loadCourses(){
  const res = await fetch(API_URL,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({action:'getCourses'})
  }).then(r=>r.json());

  const sel = document.getElementById('courseSelect');
  res.data.forEach(c=>{
    const o = document.createElement('option');
    o.value = c.id;
    o.textContent = c.name;
    sel.appendChild(o);
  });
}

/* ===============================
 * èª²ç¨‹ â†’ Slot
 * =============================== */
document.getElementById('courseSelect').onchange = async e=>{
  resetUI();
  if(!e.target.value) return;

  const res = await fetch(API_URL,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({action:'getSlotsByCourse', courseId:e.target.value})
  }).then(r=>r.json());

  slotData = res.data || [];
  renderDates();
};

/* ===============================
 * æ—¥æœŸ
 * =============================== */
function renderDates(){
  const dates = [...new Set(slotData.map(s=>s.date))];
  const box = document.getElementById('dateList');
  box.innerHTML='';
  dates.forEach(d=>{
    const b=document.createElement('button');
    b.className='slot-btn';
    b.textContent=d;
    b.onclick=()=>selectDate(d,b);
    box.appendChild(b);
  });
  document.getElementById('dateCard').classList.remove('hidden');
}

function selectDate(d,btn){
  document.querySelectorAll('#dateList .slot-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  renderSlots(d);
}

/* ===============================
 * Slot
 * =============================== */
function renderSlots(date){
  const box=document.getElementById('slotList');
  box.innerHTML='';
  slotData.filter(s=>s.date===date).forEach(s=>{
    const div=document.createElement('div');
    div.className='slot-btn';
    div.innerHTML=`
      <div class="flex justify-between items-center">
        <div>
          <div class="font-black">${periodText(s.period)}</div>
          <div class="text-xs text-slate-500">åé¡ ${s.limit}ï½œè¨­å‚™ $${s.equipFee}</div>
        </div>
        <div class="font-black text-green-600">$${s.price}</div>
      </div>`;
    div.onclick=()=>selectSlot(s,div);
    box.appendChild(div);
  });
  document.getElementById('slotCard').classList.remove('hidden');
}

function periodText(p){
  return p==='full'?'å…¨æ—¥':p==='am'?'ä¸Šåˆ':'ä¸‹åˆ';
}

function selectSlot(slot,el){
  document.querySelectorAll('#slotList .slot-btn').forEach(b=>b.classList.remove('active'));
  el.classList.add('active');
  selectedSlot = slot;
  document.getElementById('priceText').innerText='$'+slot.price;
  document.getElementById('priceCard').classList.remove('hidden');
  document.getElementById('submitCard').classList.remove('hidden');
}

/* ===============================
 * é€å‡º
 * =============================== */
async function submitRegistration(){
  if(!selectedSlot) return alert('è«‹é¸æ“‡æ™‚æ®µ');

  const res = await fetch(API_URL,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      action:'register',
      userId: currentUserId,
      name:'å­¸å“¡',
      slotId:selectedSlot.slotId,
      courseId:selectedSlot.courseId,
      period:selectedSlot.period,
      payableAmount:selectedSlot.price
    })
  }).then(r=>r.json());

  if(res.success){
    alert('å ±åå®Œæˆï¼ˆå°šæœªä»˜æ¬¾ï¼‰');
    liff.closeWindow();
  }else{
    alert(res.msg||'å ±åå¤±æ•—');
  }
}

/* ===============================
 * Reset
 * =============================== */
function resetUI(){
  ['dateCard','slotCard','priceCard','submitCard']
    .forEach(id=>document.getElementById(id).classList.add('hidden'));
}

/* ===============================
 * Init
 * =============================== */
window.onload=async()=>{
  await initLiff();
  await loadCourses();
};
</script>

</body>
</html>
