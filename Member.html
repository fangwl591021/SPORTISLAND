<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>運動島｜課程報名</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
:root{ --line:#06C755 }
.btn-line{
  background:var(--line);
  color:#fff;
  font-weight:700;
}
.badge{
  border:1px solid var(--line);
  color:var(--line);
  border-radius:9999px;
  padding:2px 10px;
  font-size:12px;
}
.day-btn{
  border:1px solid #ddd;
  border-radius:10px;
  padding:10px;
  cursor:pointer;
}
.day-btn.active{
  background:#F0FBF5;
  border-color:var(--line);
}
</style>
</head>

<body class="bg-[#F4F5F7] min-h-screen">

<!-- ===== BANNER ===== -->
<div class="w-full">
  <img src="https://aiwe.cc/wp-content/uploads/2025/12/3486bc19dc6317e16bf4f1449ec52ae4.jpg"
       class="w-full object-cover">
</div>

<!-- ===== 主容器 ===== -->
<div class="max-w-md mx-auto bg-white rounded-3xl shadow-xl -mt-16 relative z-10">

  <!-- 標題 -->
  <div class="p-6 border-b">
    <h1 class="text-xl font-black">課程報名</h1>
    <p class="text-sm text-slate-500 mt-1">請選擇上課日期與時段</p>
  </div>

  <!-- 課程選擇 -->
  <div class="p-6">
    <label class="font-bold text-sm text-[#06C755]">選擇課程</label>
    <select id="courseSelect"
      class="w-full mt-2 p-3 border rounded-xl">
    </select>
  </div>

  <!-- 日曆區 -->
  <div class="px-6 pb-6">
    <label class="font-bold text-sm text-[#06C755]">選擇上課日期</label>

    <div id="calendar" class="grid grid-cols-7 gap-2 mt-3"></div>
  </div>

  <!-- 已選清單 -->
  <div class="px-6 pb-6">
    <label class="font-bold text-sm text-[#06C755]">已選時段</label>
    <div id="selectedList" class="mt-2 space-y-2 text-sm"></div>
  </div>

  <!-- 送出 -->
  <div class="p-6 border-t">
    <button id="submitBtn" class="w-full py-4 rounded-2xl btn-line text-lg">
      確認報名
    </button>
  </div>

</div>

<!-- ===== 時段選擇彈窗 ===== -->
<div id="periodModal"
  class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">

  <div class="bg-white rounded-2xl p-6 w-[90%] max-w-sm">
    <h3 class="font-black text-lg mb-4">選擇時段</h3>

    <div class="space-y-2">
      <button onclick="selectPeriod('全日')" class="w-full p-3 border rounded-xl">全日</button>
      <button onclick="selectPeriod('上午')" class="w-full p-3 border rounded-xl">上午</button>
      <button onclick="selectPeriod('下午')" class="w-full p-3 border rounded-xl">下午</button>
    </div>

    <button onclick="closeModal()" class="mt-4 text-sm text-slate-400 w-full">
      取消
    </button>
  </div>
</div>

<script>
/* =============================
 * 基本設定
 * ============================= */
const API = "https://sport.wetw-net3.workers.dev/";
let userId = "";
let slots = [];
let selected = [];
let currentDate = "";

/* =============================
 * LIFF 初始化
 * ============================= */
async function initLIFF(){
  await liff.init({ liffId:'2008792551-CzPJtVB1' });
  if(!liff.isLoggedIn()) liff.login();
  const p = await liff.getProfile();
  userId = p.userId;
}

/* =============================
 * 載入課程
 * ============================= */
async function loadCourses(){
  const res = await fetch(API,{
    method:'POST',
    body:JSON.stringify({action:'getCourses'})
  }).then(r=>r.json());

  courseSelect.innerHTML = res.data.map(c=>
    `<option value="${c.id}">${c.名稱}（$${c.價格}）</option>`
  ).join('');

  loadCalendar();
}

/* =============================
 * 日曆（簡化 30 天）
 * ============================= */
function loadCalendar(){
  calendar.innerHTML = "";
  const today = new Date();

  for(let i=0;i<30;i++){
    const d = new Date(today);
    d.setDate(today.getDate()+i);

    const key = d.toISOString().slice(0,10);

    calendar.innerHTML += `
      <div class="day-btn"
        onclick="openPeriod('${key}')">
        <div class="text-xs text-slate-400">${key}</div>
      </div>
    `;
  }
}

/* =============================
 * 時段選擇
 * ============================= */
function openPeriod(date){
  currentDate = date;
  periodModal.classList.remove('hidden');
  periodModal.classList.add('flex');
}

function closeModal(){
  periodModal.classList.add('hidden');
  periodModal.classList.remove('flex');
}

function selectPeriod(period){
  selected.push({
    date: currentDate,
    period
  });
  renderSelected();
  closeModal();
}

/* =============================
 * 已選清單
 * ============================= */
function renderSelected(){
  selectedList.innerHTML = selected.map((s,i)=>`
    <div class="flex justify-between items-center border p-2 rounded-lg">
      <div>${s.date}｜${s.period}</div>
      <button onclick="remove(${i})" class="text-red-500">刪除</button>
    </div>
  `).join('');
}

function remove(i){
  selected.splice(i,1);
  renderSelected();
}

/* =============================
 * 送出報名
 * ============================= */
submitBtn.onclick = async ()=>{
  if(selected.length===0){
    alert("請選擇至少一個時段");
    return;
  }

  const payload = {
    action:'register',
    userId,
    courseId:courseSelect.value,
    name:'前台報名',
    absence:selected.map(s=>({
      date:s.date,
      period:s.period
    }))
  };

  const res = await fetch(API,{
    method:'POST',
    body:JSON.stringify(payload)
  }).then(r=>r.json());

  alert(res.success ? "報名完成" : res.msg);
  if(res.success) liff.closeWindow();
};

/* =============================
 * 啟動
 * ============================= */
(async()=>{
  await initLIFF();
  await loadCourses();
})();
</script>

</body>
</html>
