<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>運動島｜後台 Slot 編輯器</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Tailwind（開發版） -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
    body {
      font-family: 'Noto Sans TC', sans-serif;
      background:#F4F5F7;
    }
    .btn-line {
      background:#06C755;
      color:#fff;
      font-weight:700;
    }
    .btn-line:hover { background:#05b94d; }
    .card {
      background:#fff;
      border-radius:16px;
      border:1px solid #E5E7EB;
    }
    label { font-weight:700; }
    .hint-blue { color:#2563eb; font-size:12px; }
  </style>
</head>

<body class="pb-24">

<!-- Header -->
<div class="bg-white shadow sticky top-0 z-10">
  <div class="max-w-3xl mx-auto p-4 flex justify-between items-center">
    <h1 class="font-black text-lg">運動島｜Slot 編輯器</h1>
    <span class="text-sm text-slate-500">Admin 後台</span>
  </div>
</div>

<!-- Main -->
<div class="max-w-3xl mx-auto p-4 space-y-6">

  <!-- 課程選擇 -->
  <div class="card p-5">
    <h2 class="font-black text-lg mb-4">① 選擇課程</h2>
    <select id="courseSelect" class="w-full p-3 border rounded-xl font-bold">
      <option value="">請選擇課程</option>
    </select>
  </div>

  <!-- Slot 編輯 -->
  <div class="card p-5 hidden" id="slotEditor">
    <h2 class="font-black text-lg mb-4">② 編輯 Slot</h2>

    <div class="space-y-4">

      <div>
        <label>日期</label>
        <input id="slotDate" type="date"
          class="w-full p-3 border rounded-xl">
      </div>

      <div>
        <label>時段</label>
        <select id="slotPeriod"
          class="w-full p-3 border rounded-xl font-bold">
          <option value="full">全日</option>
          <option value="am">上午</option>
          <option value="pm">下午</option>
        </select>
        <div class="hint-blue">全日 / 上午 / 下午 各自獨立 Slot</div>
      </div>

      <div>
        <label>價格</label>
        <input id="slotPrice" type="number"
          class="w-full p-3 border rounded-xl"
          placeholder="例：1200">
      </div>

      <div>
        <label>設備租借費</label>
        <input id="slotEquip" type="number"
          class="w-full p-3 border rounded-xl"
          placeholder="例：300">
      </div>

      <div>
        <label>請假扣除金額</label>
        <input id="slotAbsence" type="number"
          class="w-full p-3 border rounded-xl"
          placeholder="例：500">
        <div class="hint-blue">報名後若選擇不出席，系統預扣</div>
      </div>

      <div>
        <label>名額</label>
        <input id="slotLimit" type="number"
          class="w-full p-3 border rounded-xl"
          placeholder="例：20">
      </div>

      <button onclick="saveSlot()"
        class="w-full py-4 btn-line rounded-2xl text-lg">
        儲存 Slot
      </button>

    </div>
  </div>

  <!-- Slot 列表 -->
  <div class="card p-5 hidden" id="slotListCard">
    <h2 class="font-black text-lg mb-4">③ 已建立 Slot</h2>
    <div id="slotList" class="space-y-3"></div>
  </div>

</div>

<script>
/* ===============================
 * API（固定走新 Worker）
 * =============================== */
const API = "https://sport-island.fangwl591021.workers.dev";

let currentCourseId = '';
let slotList = [];

/* ===============================
 * 載入課程
 * =============================== */
async function loadCourses(){
  const res = await fetch(API,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({ action:'adminGetData' })
  }).then(r=>r.json());

  const sel = document.getElementById('courseSelect');
  res.課程.forEach(c=>{
    const opt = document.createElement('option');
    opt.value = c.id;
    opt.textContent = c.name;
    sel.appendChild(opt);
  });
}

/* ===============================
 * 課程切換
 * =============================== */
document.getElementById('courseSelect').onchange = async e=>{
  currentCourseId = e.target.value;
  if(!currentCourseId) return;

  document.getElementById('slotEditor').classList.remove('hidden');
  await loadSlots();
};

/* ===============================
 * 讀 Slot
 * =============================== */
async function loadSlots(){
  const res = await fetch(API,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({ action:'adminGetSlots' })
  }).then(r=>r.json());

  slotList = (res.data || []).filter(s=>s.courseId===currentCourseId);
  renderSlotList();
}

/* ===============================
 * Slot 列表
 * =============================== */
function renderSlotList(){
  const box = document.getElementById('slotList');
  box.innerHTML = '';

  slotList.forEach(s=>{
    const div = document.createElement('div');
    div.className = 'border rounded-xl p-3 flex justify-between items-center';
    div.innerHTML = `
      <div>
        <div class="font-black">${s.date}｜${periodText(s.period)}</div>
        <div class="text-xs text-slate-500">
          價格 $${s.price} ｜ 設備 $${s.equipFee} ｜ 名額 ${s.limit}
        </div>
      </div>
    `;
    box.appendChild(div);
  });

  document.getElementById('slotListCard').classList.remove('hidden');
}

function periodText(p){
  return p==='full'?'全日':p==='am'?'上午':'下午';
}

/* ===============================
 * 儲存 Slot
 * =============================== */
async function saveSlot(){
  const data = {
    action:'adminSaveSlot',
    courseId: currentCourseId,
    date: document.getElementById('slotDate').value,
    period: document.getElementById('slotPeriod').value,
    price: document.getElementById('slotPrice').value,
    equipFee: document.getElementById('slotEquip').value,
    absenceDeduct: document.getElementById('slotAbsence').value,
    limit: document.getElementById('slotLimit').value,
    status:'開放'
  };

  const res = await fetch(API,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(data)
  }).then(r=>r.json());

  if(res.success){
    alert('Slot 已儲存');
    await loadSlots();
  } else {
    alert(res.msg || '儲存失敗');
  }
}

/* ===============================
 * Init
 * =============================== */
window.onload = loadCourses;
</script>

</body>
</html>
