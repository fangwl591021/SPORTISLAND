<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>運動島｜Slot 編輯器</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
    body {
      font-family: 'Noto Sans TC', sans-serif;
      background: #F4F5F7;
    }
    .btn-line {
      background: #06C755;
      color: #fff;
      font-weight: 700;
    }
    .btn-line:hover { background:#05b94d; }
    .card {
      background:#fff;
      border-radius:16px;
      border:1px solid #E5E7EB;
    }
    .label { font-size:13px; font-weight:700; color:#111827; }
    .hint-blue { color:#2563EB; font-size:12px; font-weight:600; }
    .hint-red { color:#DC2626; font-size:12px; font-weight:600; }
  </style>
</head>

<body class="p-6">

  <!-- Header -->
  <div class="max-w-5xl mx-auto mb-8">
    <h1 class="text-3xl font-black">Slot 編輯器</h1>
    <p class="text-slate-500 mt-1 font-medium">
      管理課程每日時段（全日 / 上午 / 下午）
    </p>
  </div>

  <!-- Slot Form -->
  <div class="card max-w-5xl mx-auto p-8 mb-10">
    <h2 class="text-xl font-black mb-6">新增 / 編輯 Slot</h2>

    <div class="grid grid-cols-2 gap-6">
      <div>
        <label class="label">課程 ID</label>
        <input id="f-courseId" class="w-full mt-2 p-3 border rounded-lg" placeholder="COURSE_xxx" />
        <p class="hint-blue mt-1">對應 Course_Master.courseId</p>
      </div>

      <div>
        <label class="label">日期</label>
        <input type="date" id="f-date" class="w-full mt-2 p-3 border rounded-lg" />
      </div>

      <div>
        <label class="label">時段</label>
        <select id="f-period" class="w-full mt-2 p-3 border rounded-lg font-bold">
          <option value="full">全日</option>
          <option value="am">上午</option>
          <option value="pm">下午</option>
        </select>
        <p class="hint-blue mt-1">對應報名日曆顯示</p>
      </div>

      <div>
        <label class="label">名額上限</label>
        <input type="number" id="f-limit" class="w-full mt-2 p-3 border rounded-lg" value="20" />
      </div>

      <div>
        <label class="label">Slot 價格</label>
        <input type="number" id="f-price" class="w-full mt-2 p-3 border rounded-lg" />
        <p class="hint-blue mt-1">該日該時段應付金額</p>
      </div>

      <div>
        <label class="label">不出席扣除金</label>
        <input type="number" id="f-absenceDeduct" class="w-full mt-2 p-3 border rounded-lg" />
        <p class="hint-red mt-1">缺席此時段扣除</p>
      </div>

      <div>
        <label class="label">設備租借費</label>
        <input type="number" id="f-equipFee" class="w-full mt-2 p-3 border rounded-lg" value="0" />
      </div>

      <div>
        <label class="label">狀態</label>
        <select id="f-status" class="w-full mt-2 p-3 border rounded-lg font-bold">
          <option value="開放">開放</option>
          <option value="停用">停用</option>
        </select>
      </div>
    </div>

    <div class="mt-8 flex justify-end space-x-4">
      <button onclick="resetForm()" class="px-6 py-3 border rounded-lg font-bold">
        清除
      </button>
      <button onclick="saveSlot()" class="px-8 py-3 btn-line rounded-lg">
        儲存 Slot
      </button>
    </div>
  </div>

  <!-- Slot List -->
  <div class="card max-w-5xl mx-auto p-8">
    <h2 class="text-xl font-black mb-6">Slot 清單</h2>
    <table class="w-full text-sm">
      <thead>
        <tr class="text-left border-b">
          <th class="py-3">課程</th>
          <th>日期</th>
          <th>時段</th>
          <th>價格</th>
          <th>扣除</th>
          <th>設備</th>
          <th>名額</th>
          <th>狀態</th>
        </tr>
      </thead>
      <tbody id="slotTable"></tbody>
    </table>
  </div>

<script>
const API = location.origin;

function resetForm() {
  ['f-courseId','f-date','f-price','f-absenceDeduct','f-equipFee']
    .forEach(id => document.getElementById(id).value = '');
  document.getElementById('f-limit').value = 20;
  document.getElementById('f-period').value = 'full';
  document.getElementById('f-status').value = '開放';
}

async function saveSlot() {
  const payload = {
    action: 'adminSaveSlot',
    courseId: f-courseId.value,
    date: f-date.value,
    period: f-period.value,
    price: Number(f-price.value),
    absenceDeduct: Number(f-absenceDeduct.value),
    equipFee: Number(f-equipFee.value),
    limit: Number(f-limit.value),
    status: f-status.value
  };

  const res = await fetch(API, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(payload)
  }).then(r=>r.json());

  if(res.success){
    alert('Slot 已儲存');
    loadSlots();
    resetForm();
  } else {
    alert(res.msg || '儲存失敗');
  }
}

async function loadSlots(){
  const res = await fetch(API,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({action:'adminGetSlots'})
  }).then(r=>r.json());

  const tbody = document.getElementById('slotTable');
  tbody.innerHTML = (res.data||[]).map(s=>`
    <tr class="border-b">
      <td class="py-3 font-mono">${s.courseId}</td>
      <td>${s.date}</td>
      <td>${s.period}</td>
      <td>$${s.price}</td>
      <td>$${s.absenceDeduct}</td>
      <td>$${s.equipFee}</td>
      <td>${s.limit}</td>
      <td>${s.status}</td>
    </tr>
  `).join('');
}

window.onload = loadSlots;
</script>
</body>
</html>
